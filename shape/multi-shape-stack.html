<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="multi-shape-behavior.html">
<link rel="import" href="../shaper/multi-d3-stack.html">
<link rel="import" href="../multi-lifecycle-behavior.html">
<!--
`multi-poly`
polymer elements for multivariate analysis (depend on crossfilter, universe and reductio)

@demo demo/index.html 
-->
<dom-module id="multi-shape-stack">
  <template>
    <style is="custom-style">
    :host {
      display: none;
    }
    </style>
    
    <svg>
      <g id="shape" class="shape bar" >
      </g>
    </svg>
  </template>
  <script>
  Polymer({

    is: 'multi-shape-stack',


    properties: {
      /**
       * `stack` stacked data
       */
      stack: {
        type: Array
      },


      // x: {
      //   type: Function,
      //   computed: 'computeAccessor(xScale, xAccessor)'
      // },

      // y: {
      //   type: Function,
      //   computed: 'computeAccessor(yScale, yAccessor)',
      //   notify: true 
      // },

      height: {
        type: Number,
        observer: '_observeHeight'
      },

      keys: {
        type: Array,
        value: function(){
          return ['count', 'count', 'count'];
        }
      },

      // valuePath: {
      //   type: String,
      // },

      // value: {
      //   type: Function
      // },

      // order: {
      //   type: Function
      // },

      // offset: {
      //   type: Function
      // },

       /**
       * `domainMin` the minimum value for the calculated domain
       */
      // domainMin: {
      //   type: Number,
      // },

      // index: {
        // type: Number
      // }
      


    },

    behaviors: [
      Polymer.multi.lifecycle,
      Polymer.multi.shape
      // Polymer.multi.xCoordinate,
      // Polymer.multi.yCoordinate,
    ],

    /**
     * `targetElement` getter override lifecycle Behavior and called during attached
     */
     get targetElement() {
      return this.$.shape;
    },

    _observeHeight: function (height) {
        if(!this.y0) {
          this.y0 = this.constant(height);
        }
    },

    // preDraw: function(host, data, duration) {
    //    this.$.shaper.computeData(data);
    //  },


    draw: function(host, data, duration) {

      if (!this.stack) {
        this._error('stack is not provided')
      }

      var height = this.height;
      var y = this.y;
      var x = this.x;
      var xScale = this.xScale;
      var yScale = this.yScale;
      var stack = this.stack;
      var colorScale = this.colorScale;

      var series =  d3.select(this.targetElement).selectAll('.serie')
          .data(stack)

      series.exit().remove();    

      series = series.enter().append('g')
        .attr('class', 'serie')
        .attr('fill', function(d) { 
          return colorScale(d.key); 
        })
        .merge(series);

     var chart =  series.selectAll('rect')
        .data(function(d) { return d; })   
    
      chart.exit().remove();

      chart = chart.enter().append('rect')
        .merge(chart);

      chart.on('click', function(d) {
         host.fire('multi-tap', d);
       });  

      if (duration)  {
        chart = chart.transition().duration(duration);
      } 

      chart
        .attr('x', function(d) { return xScale(d.data.key); })
        .attr('y', function(d) { return yScale(d[1]); })
        .attr('height', function(d) { return yScale(d[0]) - yScale(d[1]); })
        .attr('width', this.xScale.bandwidth());  


    }


  });
  </script>
</dom-module>
