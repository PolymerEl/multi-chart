<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="multi-shape-behavior.html">
<link rel="import" href="../multi-lifecycle-behavior.html">
<!--
`multi-shape-bar`
polymer elements responsible for drawing bars in a coordinate chart

@demo demo/index-bar.html 
-->
<dom-module id="multi-shape-bar">
  <template>
    <style is="custom-style">
    :host {
      display: none;
    }
    </style>
    <svg>
      <g id="shape" class="shape-bar" >
      </g>
    </svg>
  </template>
  <script>
  Polymer({

    is: 'multi-shape-bar',

    behaviors: [
      multi.lifecycle,
      multi.shape
    ],

    properties: {

      x: {
        type: Function,
        computed: 'computeAccessor(xScale, xAccessor)'
      },

      y: {
        type: Function,
        computed: 'computeAccessor(yScale, yAccessor)',
        notify: true 
      },

      height: {
        type: Number,
        observer: 'fireRefresh'
      },

      index: {
        type: String
      },
      /* 
       * `bandwidthOffset` is set will move x value of indivibars by the offset amount. typical value = 0.5 to recenter bars after grouping
       */
      bandwidthOffset: {
        type: Number
      }
     
    },

    /**
     * `targetElement` getter override lifecycle Behavior and called during attached
     */
     get targetElement() {
      return this.$.shape;
    },

    draw: function(host, data, transition) {

      var height = this.height;
      var y = this.y;
      var bandwidth = this.xScale.bandwidth;
      var bandwidthOffset = this.bandwidthOffset;
      // we might have an x-scale that does not have a bandwidth, e.g. when we have date on x-axis and use a timeScale
      if(!bandwidth) {
        bandwidth = d3.scaleBand().domain(data.map(this.x)).range(this.xScale.range()).bandwidth;
      }
      this.bandwidth = bandwidth; 

      var chart = d3.select(this.targetElement).selectAll('rect.shape').data(data);
      
      chart.exit().remove();

      chart = chart.enter().append('rect')
        .attr('class','shape bar selectable')
        .merge(chart);
     
      chart.on('click', function(d) {
          host.fire('multi-tap', d);
        });

      if (transition)  {
        chart = chart.transition().call(transition);
      }  
      

      chart.attr('x', bandwidthOffset ? (d,i) => {
          return this.x(d,i) - bandwidth(d,i) * bandwidthOffset;
        } : this.x)
        .attr('y', this.y)
        .attr('height', function(d) {
          var h = height - y(d);
          return h < 0 ? 0 : h; // prevent negative height
        })
        .attr('width', bandwidth)
        .attr('key', this.key)  // shall we remove this 
        .attr('index', this.index)
        .attr('fill', this.colorScale(this.index));
    }


  });
  </script>
</dom-module>
