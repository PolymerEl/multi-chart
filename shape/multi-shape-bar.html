<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../multi-shape-behavior.html">
<link rel="import" href="../multi-lifecycle-behavior.html">
<!--
`multi-poly`
polymer elements for multivariate analysis (depend on crossfilter, universe and reductio)

@demo demo/index.html 
-->
<dom-module id="multi-shape-bar">
  <template>
    <style is="custom-style">
    :host {
      display: none;
    }
    </style>
    <svg>
      <g id="shape" class="shape bar" >
      </g>
    </svg>
  </template>
  <script>
  Polymer({

    is: 'multi-shape-bar',


    properties: {
      
      x: {
        type: Function,
        computed: 'computeAccessor(xScale, xAccessor)'
      },

      y: {
        type: Function,
        computed: 'computeAccessor(yScale, yAccessor)',
        notify: true 
      },

      y0: {
        type: Function,
        value: function() {
          return this.constant(0);
        }
      },

      height: {
        type: Number,
        // observer: '_observeHeight'
      },

      index: {
        type: Number
      }
     
    },

    behaviors: [
      Polymer.multi.lifecycle,
      Polymer.multi.shape
      // Polymer.multi.xCoordinate,
      // Polymer.multi.yCoordinate,
    ],

    /**
     * `targetElement` getter override lifecycle Behavior and called during attached
     */
     get targetElement() {
      return this.$.shape;
    },

    _observeHeight: function (height) {
        if(!this.y0) {
          this.y0 = this.constant(height);
        }
    },

    draw: function(host, data, duration) {

      var height = this.height;
      var y = this.y;
      var y0 = this.y0;

      var chart = d3.select(this.targetElement).selectAll('rect').data(data);
      
      chart.exit().remove();

      chart = chart.enter().append('rect')
        .attr('class','chart-shape')
        .merge(chart);
     
      chart.on('click', function(d) {
          host.fire('multi-tap', d);
        });

      if (duration)  {
        chart = chart.transition().duration(duration);
      }  
      
      chart.attr('x', this.x)
        .attr('y', this.y)
        .attr('height', function(d) {
          // return y0(d) - y(d) ;
          return height - y(d) ;
        })
        .attr('width', this.xScale.bandwidth())
        .attr('key', this.key)
        .attr('fill', this.colorScale(this.index));
    }


  });
  </script>
</dom-module>
