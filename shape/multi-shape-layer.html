<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="multi-shape-behavior.html">
<link rel="import" href="../multi-lifecycle-behavior.html">
<!--
`nulti-shape-layer`
polymer elements for multivariate analysis (depend on crossfilter, universe and reductio)

@demo demo/index.html 
-->
<dom-module id="multi-shape-layer">
  <template>
    <style is="custom-style">
    :host {
      display: none;
    }
    </style>
    <svg>
      <g id="layer" class="shape layer">
      </g>
    </svg>
  </template>
  <script>
  (function() {
    'use strict';

    var identity = function(d) {
      return d;
    }

    Polymer({

      is: 'multi-shape-layer',

      properties: {


        features: {
          type: Array

        },

        // projection: {
        //   type: Function
        // },

        path: {
          type: Function,
        },

        height: {
          type: Number
        },

        width: {
          type: Number
        },

      },

      observers: [
        '_drawLayer(features, path)',
        'observeChanged(path.changed)'
      ],

      observeChanged: function() {
        if (this.features && this.path) {
          this.debounce('drawLayer', function() {
            this._drawLayer(this.features, this.path);
          }, 40);
        }
      },

      behaviors: [
        Polymer.multi.lifecycle,
        Polymer.multi.shape
      ],

      /**
       * `targetElement` getter override lifecycle Behavior and called during attached
       */
      get targetElement() {
        return this.$.layer;
      },

      _drawLayer: function(features, path) {
        var layer = d3.select(this.targetElement).selectAll('path.map-layer')

        layer = layer.data(features);

        layer.exit().remove();

        layer = layer.enter().append('path')
          .attr('class', 'map-layer')
          .merge(layer);

        layer.attr('d', path)
          .attr('fill', 'red')
          .attr('stroke', 'blue');
      },

      __draw: function(host, data, duration) {

        if (!this.arcs) {
          this._error('arcs is not provided')
        }

        var chart = d3.select(this.targetElement).selectAll('path');

        if (duration) {
          chart.each(function(d) {
            this._current = d;
          });
        }

        // var arcs = this.pie(data);
        var arcs = this.arcs; //this.$.shaper.shapedData;
        var arc = this.arc;
        var colorScale = this.colorScale;


        chart = chart.data(arcs);

        chart.exit().remove();

        chart = chart.enter().append('path')
          .attr('class', 'chart-shape')
          .merge(chart);

        chart.on('click', function(d) {
          host.fire('multi-tap', d);
        });


        if (duration) {

          //as in https://bl.ocks.org/mbostock/5100636
          function arcTween(a) {
            var i = d3.interpolate(this._current, a);
            this._current = i(0);
            return function(t) {
              return arc(i(t));
            };
          }

          chart = this.setTransition(chart, duration);

          chart
            .attrTween('d', arcTween)

        } else {
          chart
            .attr('d', arc);
        }

        chart.attr('key', function(d) {
            return d.data.key
          })
          .attr('fill', function(d) {
            return colorScale(d.data.key)
          });
      }

    });
  })();
  </script>
</dom-module>
