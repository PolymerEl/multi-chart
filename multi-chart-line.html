<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="multi-base-behavior.html">
<link rel="import" href="multi-selector-behavior.html">
<link rel="import" href="multi-color-behavior.html">
<link rel="import" href="multi-coordinate-grid-behavior.html">
<link rel="import" href="multi-shaper-behavior.html">
<link rel="import" href="multi-axis.html">
<!-- <link rel="import" href="multi-brush.html"> -->
<link rel="import" href="multi-accessor.html">
<link rel="import" href="multi-shared-styles.html">
<!-- <link rel="import" href="multi-axis-behaviors.html"> -->
<!--
`multi-poly`
polymer elements for multivariate analysis (depend on crossfilter, universe and reductio)

@demo demo/index.html 
-->
<dom-module id="multi-chart-line">
  <template>
    <style is="custom-style" include="multi-charts multi-charts-line">

    </style>
    <h2 class="title">[[title]]</h2>
    <h3 class="subtitle">[[subtitle]]</h3>
    <multi-axis ref="xAxis" width="[[chartWidth]]" height="[[chartHeight]]" family="{{xScaleFamily}}" scale="{{xScale}}" domain="[[xDomain]]" range="[[xRange]]" ></multi-axis>
    <multi-axis ref="yAxis" width="[[chartWidth]]" height="[[chartHeight]]" axis-type="left" domain="[[yDomain]]" range="[[yRange]]" scale="{{yScale}}"></multi-axis>
    <multi-scale scale-type="scaleOrdinal" range="[[colorRange]]" scale="{{colorScale}}"></multi-scale>
    <multi-accessor accessor="{{xAccessor}}" accessor-path="key"></multi-accessor>
    <multi-accessor accessor="{{yAccessor}}" series="[[series]]">
      <!-- <multi-brush brush-type="brushX" brush="{{brush}}" extent="[[extent]]"></multi-brush> -->
    </multi-accessor>
    <svg id="svg">
      <g id="chartContent">
        <g id="chart" class="chart">
          <!-- <path id="chartPath" class="chart line"></path> -->
        </g>
        <g id="xAxis" class="axis x-axis">
          <text id="xAxisText" class="axis-text x-axis" x="0" y="30" dx="0" text-anchor="end"></text>
        </g>
        <g id="yAxis" class="axis y-axis">
          <text id="yAxisText" class="axis-text y-axis" transform="rotate(-90)" y="6" dy=".71em" text-anchor="end"></text>
        </g>
        <g id="brush" class="brush"></g>
      </g>
    </svg>
  </template>
  <script>
  Polymer({

    is: 'multi-chart-line',

    properties: {
      selectionType: {
        type: String,
        value: 'brushX'
      },

      yAxisText: {
        type: String,
        value: 'yAxis',
        observer: 'observeYAxisText'
      },
      xAxisText: {
        type: String,
        value: 'xAxis',
        observer: 'observeXAxisText'
      },



      series: {
        type: Array,
        value: [{
          'label': 'count',
          'path': '+value.count'
            // }, {
            //   'label': 'average',
            //   'path': '+value.average'
        }]
      },

      // shaper: {
      //   type: Function,
      //   value: function() {
      //     return d3.line
      //   }
      // },
      chartElement: {
        type: String,
        value: 'path'
      },
      chartClass: {
        type: String,
        value: 'line'
      }

    },
    observeYAxisText: function(text) {
      d3.select(this.$.yAxisText).text(text)
    },

    observeXAxisText: function(text) {
      d3.select(this.$.xAxisText).text(text)
    },

    behaviors: [
      multi.base,
      multi.shaper,
      multi.color,
      multi.coordinateGrid,
      multi.selector
      // multiverse.axis
    ],

    // getXDomain : function(data) {
    //   return d3.extent(data, this.xAccessor);
    // },

    buildShaper: function(accessor, i) {
      var me = this,
        xScale = me.xScale,
        yScale = me.yScale,
        xAccessor = me.xAccessor;

      return this.mixin(
        this.buildBaseShaper(accessor, i), {
          line: d3.line()
            .x(function(d) {
              return xScale(xAccessor(d));
            })
            .y(function(d) {
              return yScale(accessor(d));
            })
        });
    },

    handleChart: function(chart, data) {
      var me = this;

      var colorScale = me.colorScale;
      var colorAccessor = me.colorAccessor;
      var shaper =  chart.datum();

      if (me.duration) {
        chart = chart.transition().duration(me.duration);
      }
      chart.style('stroke', function(d, i) {
          return colorScale(colorAccessor(d, i));
        })
        .attr('key', shaper.key)
        .attr('d', function(d, i) {
          return d.line(data);
        });
    }


  });
  </script>
</dom-module>
