<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="multi-base-behavior.html">
<link rel="import" href="multi-shaper-behavior.html">
<link rel="import" href="multi-color-behavior.html">
<link rel="import" href="multi-selector-behavior.html">
<!-- <link rel="import" href="multi-brush-behavior.html"> -->
<link rel="import" href="multi-coordinate-grid-behavior.html">
<link rel="import" href="multi-axis.html">
<link rel="import" href="multi-scale.html">
<!-- <link rel="import" href="multi-brush.html"> -->
<link rel="import" href="multi-accessor.html">
<link rel="import" href="multi-shared-styles.html">
<!-- <link rel="import" href="multi-axis-behaviors.html"> -->
<!--
`multi-poly`
polymer elements for multivariate analysis (depend on crossfilter, universe and reductio)

@demo demo/index.html 
-->
<dom-module id="multi-shaper-bar">
  <template>
    <style is="custom-style" include="multi-charts multi-charts-selector">
      
    </style>
  </template>
  <script>
  Polymer({

    is: 'multi-shaper-bar',

    properties: {
        
      selectionType : {
        type: String,
        value: 'brushX'
      },

      ellasticX: {
        type: Boolean,
        value: false
      },

      ellasticY: {
        type: Boolean,
        value: true
      },

      yAxisText: {
        type: String,
        value: 'yAxis',
        observer: 'observeYAxisText'
      },
      xAxisText: {
        type: String,
        value: 'xAxis',
        observer: 'observeXAxisText'
      },

      series: {
        type: Array,
        value: [{
          'label': 'count',
          'path': '+value.count'
            // }, {
            //   'label': 'average',
            //   'path': '+value.average'
        }]
      },

      chartElement: {
        type: String,
        value: 'g'
      },

      chartClass: {
        type: String,
        value: 'bar'
      }

    },
    observeYAxisText: function(text) {
      d3.select(this.$.yAxisText).text(text);
    },

    observeXAxisText: function(text) {
      d3.select(this.$.xAxisText).text(text);
    },

    behaviors: [
      multi.base,
      multi.shaper,
      multi.color,
      multi.coordinateGrid,
      multi.selector
      // multi.brush,
    ],

    // getXDomain : function(data) {
    //   return data.map( this.xAccessor);
    // },

    buildShaper: function(accessor, i) {

      var xScale = this.xScale,
        yScale = this.yScale,
        xAccessor = this.xAccessor;
      
      return this.mixin(
        this.buildBaseShaper(accessor, i),{
        x: function(d) {
          return xScale(xAccessor(d));
        },
        y: function(d) {
          return yScale(accessor(d));
        }
      });
    },

    handleChart: function(chart, data) {

      var me = this;
      var height = me.chartHeight;
      var colorScale = me.colorScale;
      var colorAccessor = me.colorAccessor;
      var shaper =  chart.datum();

      chart = chart.selectAll('rect').data(data);
      chart.exit().remove();

      chart = chart.enter().append('rect')
        .attr('class','chart-shape')
        .merge(chart);
     
      chart.on('click', function(d) {
          me.fire('multi-tap', d);
        });

      if (me.duration)  {
        chart = chart.transition().duration(me.duration);
      }  
      
      chart.attr('x', function(d) {
          return shaper.x(d);
        })
        .attr('y', function(d) {
          return shaper.y(d);
        })
        .attr('height', function(d) {
          return height - shaper.y(d);
        })
        .attr('width', me.xScale.bandwidth())
        .attr('key', shaper.key)
        .attr('fill', function(d, i) {
          // return colorScale(colorAccessor(d,i));
          return colorScale(shaper.serie);
        });

    }

  });
  </script>
</dom-module>
