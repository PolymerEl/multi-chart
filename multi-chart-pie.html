<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="multi-base-behavior.html">
<link rel="import" href="multi-shaper-behavior.html">
<link rel="import" href="multi-selector-behavior.html">
<link rel="import" href="multi-color-behavior.html">
<link rel="import" href="multi-axis.html">
<!-- <link rel="import" href="multi-brush.html"> -->
<link rel="import" href="multi-accessor.html">
<link rel="import" href="multi-shared-styles.html">
<!-- <link rel="import" href="multi-axis-behaviors.html"> -->
<!--
`multi-poly`
polymer elements for multivariate analysis (depend on crossfilter, universe and reductio)

@demo demo/index.html 
-->
<dom-module id="multi-chart-pie">
  <template>
    <style is="custom-style" include="multi-charts multi-charts-selector">

    </style>
    <h2 class="title">[[title]]</h2>
    <h3 class="subtitle">[[subtitle]]</h3>
    <!-- Polymer has problem with handling namespace (https://github.com/Polymer/polymer/pull/3372): multi-axis is outside SVG -->
    <!-- <multi-axis scale="{{xScale}}" scale-type="scaleBand" padding="0.1" domain="[[xDomain]]" range="[[xRange]]" axis="{{xAxis}}"></multi-axis>
    <multi-axis axis-type="left" domain="[[yDomain]]" range="[[yRange]]" scale="{{yScale}}" axis="{{yAxis}}"></multi-axis> -->
    <multi-scale scale-type="scaleOrdinal" range="[[colorRange]]" scale="{{colorScale}}"></multi-scale>
    <multi-accessor accessor="{{xAccessor}}" accessor-path="key"></multi-accessor>
    <multi-accessor accessor="{{yAccessor}}" accessor-path="+value.count"></multi-accessor>
    <!-- <multi-brush brush-type="brushX" brush="{{brush}}" extent="[[extent]]" x-scale="[[xScale]]" y-scale="[[yScale]]"></multi-brush> -->
    <svg id="svg">
      <g id="chartContent">
        <g id="chart" class="chart">
        </g>
        <!--  <g id="xAxis" class="axis x-axis">
          <text id="xAxisText" class="axis-text x-axis" x="0" y="30" dx="0" text-anchor="end"></text>
        </g>
        <g id="yAxis" class="axis y-axis">
          <text id="yAxisText" class="axis-text y-axis" transform="rotate(-90)" y="6" dy=".71em" text-anchor="end"></text>
        </g> -->
        <!-- <g id="brush" class="brush"></g> -->
      </g>
    </svg>
  </template>
  <script>
  Polymer({

    is: 'multi-chart-pie',

    properties: {

      // yAxisText: {
      //   type: String,
      //   value: 'yAxis',
      //   observer: 'observeYAxisText'
      // },
      // xAxisText: {
      //   type: String,
      //   value: 'xAxis',
      //   observer: 'observeXAxisText'
      // },

      selectionType: {
        type: String,
        value: 'select'
      },

      series: {
        type: Array,
        value: [{
          'label': 'count',
          'path': '+value.count'
        }]
      },

      chartElement: {
        type: String,
        value: 'g'
      },
      chartClass: {
        type: String,
        value: 'pie'
      },
      innerRadius: {
        type: Number,
        value: 0
      },

      outerRadius: {
        type: Function,
        value: function() {
          var me = this;
          return function(d,i) {
            return Math.min(me.chartWidth, me.chartHeight) / 2 ;
          };
        }
      }

    },

    behaviors: [
      multi.base,
      multi.shaper,
      multi.color,
      multi.selector
    ],

    getXDomain: function(data) {
      return data.map(this.xAccessor);
    },

    buildShaper: function(accessor, i) {
      var me = this;
      // xScale = me.xScale, 
      // yScale = me.yScale;
      xAccessor = me.xAccessor;

      return {
        pie: d3.pie()
          .value(function(d) {
            return accessor(d);
          }),
        // because the d3.arc returns the original data under d.data;
        key: function(d) {
          return xAccessor(d.data);
        }
      };
    },

    handleChart: function(chart, data) {
      var me = this;

      var shaper = chart.datum();
      var colorScale = me.colorScale;
      var colorAccessor = me.colorAccessor;
      var arcs = shaper.pie(data);
      var arc = d3.arc()
        .innerRadius(me.innerRadius)
        .outerRadius(me.outerRadius);

      chart = chart.selectAll('.arc').data(arcs);

      chart.exit().remove();

      chart = chart.enter().append('path')
        .attr('class', 'arc chart-shape')
        .merge(chart);

      chart.on('click', function(d) {
        me.fire('multi-tap', d);
      });

      if (me.duration) {
        chart = chart.transition().duration(me.duration);
      }

      chart
        .attr('d', arc)
        .attr('key', shaper.key)
        .attr('fill', function(d, i) {
          return colorScale(colorAccessor(d, i));
        });

    },

    handleChartContent: function(contentSel) {
      contentSel
        .attr('transform', 'translate(' + (this.margin.left + this.chartWidth / 2) + ',' + (this.margin.top + this.chartHeight / 2) + ')');
    }


  });
  </script>
</dom-module>
